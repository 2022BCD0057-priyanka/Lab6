name: Lab4 ML Automation (CI/CD)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # =========================
  # JOB 1: TRAIN (CI)
  # =========================
  train:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run training script
      run: python script/train.py

    - name: Job Summary (Training)
      run: |
        echo "## Lab 4 – Automated Training Results" >> $GITHUB_STEP_SUMMARY
        echo "**Name:** Priyanka Kumari" >> $GITHUB_STEP_SUMMARY
        echo "**Roll No:** 2022BCD0057" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Metrics" >> $GITHUB_STEP_SUMMARY
        cat output/metrics.json >> $GITHUB_STEP_SUMMARY

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lab4-artifacts-python-${{ matrix.python-version }}
        path: output/

  # =========================
  # JOB 2: DEPLOY (CD)
  # =========================
  deploy:
    needs: train
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Download artifacts (Python 3.11)
      uses: actions/download-artifact@v4
      with:
        name: lab4-artifacts-python-3.11
        path: artifacts

    - name: Read metrics
      run: |
        python - <<EOF
        import json, os
        with open("artifacts/metrics.json") as f:
            m = json.load(f)
        with open(os.environ["GITHUB_ENV"], "a") as env:
            env.write(f"R2={m['R2_Score']}\n")
        EOF

    - name: Compare metrics
      env:
        BEST_R2: ${{ vars.BEST_R2 }}
      run: |
        python - <<EOF
        import os
        cur = float(os.environ["R2"])
        best = float(os.environ.get("BEST_R2", "-999"))
        if cur <= best:
            print("2022BCD0057 ---- Metric did not improve")
            exit(1)
        print("Metric improved, proceeding to deployment")
        EOF

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: 2022bcd0057priyanka
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        push: true
        tags: 2022bcd0057priyanka/wine_predict_2022bcd0057:latest

    - name: Job Summary (Deployment)
      run: |
        echo "## Lab 4 – Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Name:** Priyanka Kumari" >> $GITHUB_STEP_SUMMARY
        echo "**Roll No:** 2022BCD0057" >> $GITHUB_STEP_SUMMARY
        echo "**Docker Image:** 2022bcd0057priyanka/wine_predict_2022bcd0057:latest" >> $GITHUB_STEP_SUMMARY

    - name: Update BEST_R2 variable
      run: |
        curl -X PATCH \
          -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/actions/variables/BEST_R2 \
          -d "{\"name\":\"BEST_R2\",\"value\":\"${R2}\"}"
